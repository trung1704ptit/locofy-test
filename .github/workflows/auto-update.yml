name: ğŸ”„ Auto Dependency Updater

on:
  schedule:
    - cron: '0 0 * * 0' # every sunday at 12:00 AM UTC (adjust as needed)
  workflow_dispatch: # allow manual trigger from Actions tab

permissions:
  contents: write
  pull-requests: write

jobs:
  update-dependencies:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20 # or your project's version

      - name: ğŸ“¦ Upgrade dependencies (Fail-Safe)
        run: |
          set -e  # Exit on any error

          echo "ğŸ” Backing up original package.json..."
          cp package.json package.json.backup

          echo "ğŸ“‹ Installing npm-check-updates..."
          npm install -g npm-check-updates

          echo "ğŸ”„ Upgrading dependencies..."
          ncu -u

          echo "ğŸ§ª Testing npm install after upgrades..."
          if npm install; then
            echo "âœ… npm install succeeded after upgrades"
          else
            echo "âŒ npm install failed after upgrades - reverting changes"
            cp package.json.backup package.json
            echo "ğŸ§¹ Cleaning up backup..."
            rm -f package.json.backup
            exit 1
          fi

          echo "ğŸ”’ Running npm audit fix..."
          if npm audit fix; then
            echo "âœ… npm audit fix completed"
          else
            echo "âš ï¸ npm audit fix had issues, but continuing..."
          fi

          echo "ğŸ§ª Final verification with npm install..."
          if npm install; then
            echo "âœ… Final npm install verification passed"
          else
            echo "âŒ Final verification failed - reverting changes"
            cp package.json.backup package.json
            npm install
            echo "âš ï¸ Skipping commit due to dependency conflict"
            echo "ğŸ§¹ Cleaning up backup..."
            rm -f package.json.backup
            exit 0
          fi

          echo "ğŸ§¹ Cleaning up backup..."
          rm -f package.json.backup

      - name: ğŸ§  Commit and Push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if [ -n "$(git status --porcelain)" ]; then
            echo "ğŸ“ Changes detected, committing..."
            git add .
            git commit -m "chore: ğŸ”„ auto-dependency upgrade"
            git push origin ${{ github.ref_name }}
            echo "âœ… Successfully pushed dependency updates"
          else
            echo "âœ… No changes to commit"
          fi
